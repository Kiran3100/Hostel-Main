### Combined Content from Folder: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin ###



# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin =====

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\assignments.py ---
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, status

from app.api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.admin.admin_hostel_assignment import (
    AdminHostelAssignment,
    AssignmentCreate,
    AssignmentUpdate,
    BulkAssignment,
    RevokeAssignment,
    AssignmentList,
    HostelAdminList,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import AdminHostelAssignmentService

router = APIRouter(prefix="/assignments")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


# -------- Admin → Hostels -------- #


@router.get(
    "/admins/{admin_id}",
    response_model=AssignmentList,
    summary="List hostel assignments for an admin",
)
async def list_admin_assignments(
    admin_id: UUID = Path(..., description="Admin ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> AssignmentList:
    """
    Return all hostel assignments for a given admin, including primary flags and permissions.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.list_assignments_for_admin(admin_id=admin_id)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}",
    response_model=AdminHostelAssignment,
    status_code=status.HTTP_201_CREATED,
    summary="Assign an admin to a hostel",
)
async def create_admin_assignment(
    admin_id: UUID,
    payload: AssignmentCreate,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Create a single admin↔hostel assignment.

    Enforces:
    - Uniqueness per (admin, hostel)
    - At most one primary hostel per admin
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.create_assignment(admin_id=admin_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.patch(
    "/admins/{admin_id}/{assignment_id}",
    response_model=AdminHostelAssignment,
    summary="Update admin↔hostel assignment",
)
async def update_admin_assignment(
    admin_id: UUID,
    assignment_id: UUID,
    payload: AssignmentUpdate,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Update assignment metadata (permissions, primary flag, etc.).
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.update_assignment(
            admin_id=admin_id,
            assignment_id=assignment_id,
            data=payload,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}/bulk",
    response_model=List[AdminHostelAssignment],
    summary="Bulk assign admin to multiple hostels",
)
async def bulk_assign_admin(
    admin_id: UUID,
    payload: BulkAssignment,
    uow: UnitOfWork = Depends(get_uow),
) -> List[AdminHostelAssignment]:
    """
    Bulk-assign an admin to multiple hostels in one call.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.bulk_assign(admin_id=admin_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/admins/{admin_id}/{assignment_id}/revoke",
    response_model=AdminHostelAssignment,
    summary="Revoke admin↔hostel assignment",
)
async def revoke_admin_assignment(
    admin_id: UUID,
    assignment_id: UUID,
    payload: RevokeAssignment,
    uow: UnitOfWork = Depends(get_uow),
) -> AdminHostelAssignment:
    """
    Revoke an assignment with a reason; typically marks it inactive and records revoked_date.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.revoke_assignment(
            admin_id=admin_id,
            assignment_id=assignment_id,
            data=payload,
        )
    except ServiceError as exc:
        raise _map_service_error(exc)


# -------- Hostel → Admins -------- #


@router.get(
    "/hostels/{hostel_id}",
    response_model=HostelAdminList,
    summary="List admins for a hostel",
)
async def list_hostel_admins(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> HostelAdminList:
    """
    List all admins assigned to a given hostel, with metadata.
    """
    service = AdminHostelAssignmentService(uow)
    try:
        return service.list_admins_for_hostel(hostel_id=hostel_id)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\dashboard.py ---
from __future__ import annotations

from datetime import date as Date
from fastapi import APIRouter, Depends, HTTPException, Query, status

from app.api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.analytics.platform_analytics import (
    PlatformMetrics,
    GrowthMetrics,
    PlatformUsageAnalytics,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import SuperAdminDashboardService

router = APIRouter(prefix="/dashboard")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/platform/metrics/latest",
    response_model=PlatformMetrics,
    summary="Get latest platform-wide metrics (super admin)",
)
async def get_latest_platform_metrics(
    uow: UnitOfWork = Depends(get_uow),
) -> PlatformMetrics:
    """
    Fetch the latest platform-level metrics snapshot.

    Backed by SuperAdminDashboardService.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_latest_platform_metrics()
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/platform/growth",
    response_model=GrowthMetrics,
    summary="Get growth metrics for a period (super admin)",
)
async def get_growth_metrics(
    period_start: Date = Query(..., description="Start Date (inclusive)"),
    period_end: Date = Query(..., description="End Date (inclusive)"),
    uow: UnitOfWork = Depends(get_uow),
) -> GrowthMetrics:
    """
    Fetch growth metrics (hostels, revenue, users) for the given period.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_growth_metrics(period_start=period_start, period_end=period_end)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/platform/usage/latest",
    response_model=PlatformUsageAnalytics,
    summary="Get latest platform usage analytics (super admin)",
)
async def get_latest_platform_usage(
    uow: UnitOfWork = Depends(get_uow),
) -> PlatformUsageAnalytics:
    """
    Fetch the latest API/platform usage analytics snapshot.
    """
    service = SuperAdminDashboardService(uow)
    try:
        return service.get_latest_platform_usage()
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\hostels.py ---
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, status

from app.api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.hostel.hostel_base import HostelCreate, HostelUpdate
from app.schemas.hostel.hostel_response import HostelResponse, HostelDetail
from app.schemas.hostel.hostel_filter import HostelFilterParams
from app.services.common.unit_of_work import UnitOfWork
from app.services.hostel import HostelService

router = APIRouter(prefix="/hostels")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/",
    response_model=List[HostelResponse],
    summary="List hostels (admin view)",
)
async def list_hostels(
    filters: HostelFilterParams = Depends(),
    uow: UnitOfWork = Depends(get_uow),
) -> List[HostelResponse]:
    """
    List hostels for admin users.

    Uses HostelService.list_hostels with HostelFilterParams.
    """
    service = HostelService(uow)
    try:
        return service.list_hostels(filters=filters)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/",
    response_model=HostelDetail,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new hostel",
)
async def create_hostel(
    payload: HostelCreate,
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Create a new hostel.

    Ensures slug uniqueness and applies default flags.
    """
    service = HostelService(uow)
    try:
        return service.create_hostel(data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/{hostel_id}",
    response_model=HostelDetail,
    summary="Get hostel details (admin)",
)
async def get_hostel(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Retrieve detailed hostel information for admin users.
    """
    service = HostelService(uow)
    try:
        return service.get_hostel(hostel_id=hostel_id)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.patch(
    "/{hostel_id}",
    response_model=HostelDetail,
    summary="Update a hostel (admin)",
)
async def update_hostel(
    hostel_id: UUID = Path(..., description="Hostel ID"),
    payload: HostelUpdate = ...,
    uow: UnitOfWork = Depends(get_uow),
) -> HostelDetail:
    """
    Partially update hostel fields.

    Delegates to HostelService.update_hostel.
    """
    service = HostelService(uow)
    try:
        return service.update_hostel(hostel_id=hostel_id, data=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\multi_hostel.py ---
"""
Multi-Hostel Dashboard API

Provides consolidated dashboard views for administrators managing
multiple hostels, aggregating metrics and analytics across properties.
"""

from __future__ import annotations

from typing import Annotated, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Query, status

from app.api.deps import get_current_active_user, get_uow
from app.core.exceptions import (
    ConflictError,
    NotFoundError,
    ServiceError,
    ValidationError,
)
from app.models.core import User
from app.schemas.admin.multi_hostel_dashboard import MultiHostelDashboard
from app.services.admin import MultiHostelDashboardService
from app.services.common.unit_of_work import UnitOfWork

router = APIRouter(prefix="/multi-hostel")


# ==================== Error Mapping ====================


def _map_service_error(exc: ServiceError) -> HTTPException:
    """
    Map service-layer exceptions to appropriate HTTP exceptions.

    Args:
        exc: Service exception to map

    Returns:
        Corresponding HTTPException with appropriate status code
    """
    error_map = {
        NotFoundError: (status.HTTP_404_NOT_FOUND, str(exc)),
        ValidationError: (status.HTTP_422_UNPROCESSABLE_ENTITY, str(exc)),
        ConflictError: (status.HTTP_409_CONFLICT, str(exc)),
    }

    for error_type, (status_code, detail) in error_map.items():
        if isinstance(exc, error_type):
            return HTTPException(status_code=status_code, detail=detail)

    return HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail=str(exc),
    )


# ==================== Helper Functions ====================


def _resolve_admin_id(
    admin_id: Optional[UUID],
    current_user: User,
) -> UUID:
    """
    Resolve admin ID from explicit parameter or current user.

    Args:
        admin_id: Explicitly provided admin ID (optional)
        current_user: Currently authenticated user

    Returns:
        Resolved admin ID

    Raises:
        HTTPException: If admin_id not provided and user is not an admin
    """
    if admin_id is not None:
        return admin_id

    # Attempt to derive from current user's admin profile
    admin_profile = getattr(current_user, "admin_profile", None)
    if admin_profile is None:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Current user does not have an admin profile. "
            "Please provide an explicit admin_id.",
        )

    return admin_profile.id


# ==================== Endpoints ====================


@router.get(
    "/dashboard",
    response_model=MultiHostelDashboard,
    status_code=status.HTTP_200_OK,
    summary="Get Multi-Hostel Dashboard",
    description="Retrieve consolidated dashboard data for an admin managing multiple hostels.",
    responses={
        200: {"description": "Successfully retrieved dashboard data"},
        403: {"description": "User is not an admin or lacks permissions"},
        404: {"description": "Admin not found or has no hostel assignments"},
    },
)
async def get_multi_hostel_dashboard(
    admin_id: Annotated[
        Optional[UUID],
        Query(
            description="Admin ID (optional; defaults to current user's admin profile)",
        ),
    ] = None,
    current_user: Annotated[User, Depends(get_current_active_user)] = ...,
    uow: Annotated[UnitOfWork, Depends(get_uow)] = ...,
) -> MultiHostelDashboard:
    """
    Build consolidated multi-hostel dashboard.

    Aggregates data across all hostels assigned to the admin:
    - Per-hostel key metrics (occupancy, revenue, issues)
    - Cross-hostel comparisons
    - Trend analysis
    - Alert notifications
    - Priority items requiring attention

    Admin ID resolution:
    - If `admin_id` is provided, uses that value
    - Otherwise, derives from current authenticated user's admin profile
    - Fails if user is not an admin and no admin_id provided

    Dashboard includes:
    - Summary cards for each hostel
    - Comparative analytics
    - Recent activity feed
    - Pending tasks and alerts
    - Performance indicators
    """
    # Resolve admin_id from parameter or current user
    resolved_admin_id = _resolve_admin_id(admin_id, current_user)

    service = MultiHostelDashboardService(uow)
    try:
        return await service.get_dashboard(admin_id=resolved_admin_id)
    except ServiceError as exc:
        raise _map_service_error(exc) from exc

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\overrides.py ---
"""
Admin Override Management API

Handles administrator overrides of supervisor/system decisions with
comprehensive audit logging and statistical tracking.
"""

from __future__ import annotations

from datetime import date as Date
from typing import Annotated, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, Path, Query, status

from app.api.deps import get_uow
from app.core.exceptions import (
    ConflictError,
    NotFoundError,
    ServiceError,
    ValidationError,
)
from app.schemas.admin.admin_override import (
    AdminOverrideRequest,
    OverrideLog,
    OverrideSummary,
    SupervisorOverrideStats,
)
from app.services.admin import AdminOverrideService
from app.services.common.unit_of_work import UnitOfWork

router = APIRouter(prefix="/overrides")


# ==================== Error Mapping ====================


def _map_service_error(exc: ServiceError) -> HTTPException:
    """
    Map service-layer exceptions to appropriate HTTP exceptions.

    Args:
        exc: Service exception to map

    Returns:
        Corresponding HTTPException with appropriate status code
    """
    error_map = {
        NotFoundError: (status.HTTP_404_NOT_FOUND, str(exc)),
        ValidationError: (status.HTTP_422_UNPROCESSABLE_ENTITY, str(exc)),
        ConflictError: (status.HTTP_409_CONFLICT, str(exc)),
    }

    for error_type, (status_code, detail) in error_map.items():
        if isinstance(exc, error_type):
            return HTTPException(status_code=status_code, detail=detail)

    return HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail=str(exc),
    )


# ==================== Endpoints ====================


@router.post(
    "/",
    response_model=OverrideLog,
    status_code=status.HTTP_201_CREATED,
    summary="Create Admin Override",
    description="Record an administrative override of a supervisor or system decision.",
    responses={
        201: {"description": "Override successfully recorded"},
        400: {"description": "Invalid override data"},
        403: {"description": "Insufficient privileges to override"},
        404: {"description": "Target entity not found"},
        409: {"description": "Override conflicts with existing decision"},
        422: {"description": "Validation error in override request"},
    },
)
async def create_admin_override(
    payload: AdminOverrideRequest,
    uow: Annotated[UnitOfWork, Depends(get_uow)],
) -> OverrideLog:
    """
    Record an admin override of a previous decision.

    Use cases:
    - Overriding supervisor complaint resolutions
    - Bypassing automated rejection rules
    - Emergency leave approvals
    - Maintenance priority escalation

    Actions performed:
    - Validates admin authority
    - Records original decision
    - Logs override justification
    - Updates entity status
    - Creates audit trail
    - Notifies affected parties

    All overrides are immutable and fully audited.
    """
    service = AdminOverrideService(uow)
    try:
        return await service.create_override(request=payload)
    except ServiceError as exc:
        raise _map_service_error(exc) from exc


@router.get(
    "/entity/{entity_type}/{entity_id}",
    response_model=list[OverrideLog],
    status_code=status.HTTP_200_OK,
    summary="List Overrides for Entity",
    description="Retrieve all administrative overrides applied to a specific entity.",
    responses={
        200: {"description": "Successfully retrieved override history"},
        404: {"description": "Entity not found"},
    },
)
async def list_overrides_for_entity(
    entity_type: Annotated[
        str,
        Path(
            description="Entity type (e.g., complaint, maintenance_request, leave_application)",
            example="complaint",
        ),
    ],
    entity_id: Annotated[
        UUID,
        Path(description="Unique identifier of the entity"),
    ],
    uow: Annotated[UnitOfWork, Depends(get_uow)],
) -> list[OverrideLog]:
    """
    Fetch complete override history for an entity.

    Returns chronological list of all overrides including:
    - Override timestamp
    - Admin who performed override
    - Original decision details
    - Override justification
    - Resulting status change

    Useful for:
    - Decision audit trails
    - Compliance reviews
    - Dispute resolution
    - Pattern analysis
    """
    service = AdminOverrideService(uow)
    try:
        return await service.list_overrides_for_entity(
            entity_type=entity_type,
            entity_id=entity_id,
        )
    except ServiceError as exc:
        raise _map_service_error(exc) from exc


@router.get(
    "/summary",
    response_model=OverrideSummary,
    status_code=status.HTTP_200_OK,
    summary="Get Override Summary",
    description="Retrieve aggregated override statistics for a period with optional filters.",
    responses={
        200: {"description": "Successfully retrieved override summary"},
        400: {"description": "Invalid filter or Date parameters"},
        422: {"description": "Validation error in query parameters"},
    },
)
async def get_override_summary(
    hostel_id: Annotated[
        Optional[UUID],
        Query(description="Filter by specific hostel"),
    ] = None,
    supervisor_id: Annotated[
        Optional[UUID],
        Query(description="Filter by supervisor whose decisions were overridden"),
    ] = None,
    start_date: Annotated[
        Optional[Date],
        Query(description="Start Date for summary period (inclusive)"),
    ] = None,
    end_date: Annotated[
        Optional[Date],
        Query(description="End Date for summary period (inclusive)"),
    ] = None,
    uow: Annotated[UnitOfWork, Depends(get_uow)] = ...,
) -> OverrideSummary:
    """
    Generate override statistics summary.

    Provides aggregated metrics:
    - Total override count
    - Overrides by entity type
    - Overrides by reason
    - Trend analysis
    - Hostel/supervisor breakdown

    Supports filtering by:
    - Date range
    - Specific hostel
    - Specific supervisor
    """
    # Validate Date range if both provided
    if start_date and end_date and start_date > end_date:
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            detail="start_date must be before or equal to end_date",
        )

    service = AdminOverrideService(uow)
    try:
        return await service.get_override_summary(
            hostel_id=hostel_id,
            supervisor_id=supervisor_id,
            start_date=start_date,
            end_date=end_date,
        )
    except ServiceError as exc:
        raise _map_service_error(exc) from exc


@router.get(
    "/supervisors/{supervisor_id}/stats",
    response_model=SupervisorOverrideStats,
    status_code=status.HTTP_200_OK,
    summary="Get Supervisor Override Statistics",
    description="Retrieve detailed override statistics for a specific supervisor.",
    responses={
        200: {"description": "Successfully retrieved supervisor stats"},
        404: {"description": "Supervisor not found"},
    },
)
async def get_supervisor_override_stats(
    supervisor_id: Annotated[
        UUID,
        Path(description="Unique identifier of the supervisor"),
    ],
    start_date: Annotated[
        Optional[Date],
        Query(description="Start Date for statistics period (inclusive)"),
    ] = None,
    end_date: Annotated[
        Optional[Date],
        Query(description="End Date for statistics period (inclusive)"),
    ] = None,
    uow: Annotated[UnitOfWork, Depends(get_uow)] = ...,
) -> SupervisorOverrideStats:
    """
    Get detailed override statistics for a supervisor.

    Analyzes:
    - Total decisions made
    - Number of decisions overridden
    - Override rate percentage
    - Override reasons breakdown
    - Time-based trends
    - Entity type distribution

    Useful for:
    - Performance reviews
    - Training needs assessment
    - Quality assurance
    - Process improvement
    """
    # Validate Date range if both provided
    if start_date and end_date and start_date > end_date:
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            detail="start_date must be before or equal to end_date",
        )

    service = AdminOverrideService(uow)
    try:
        return await service.get_supervisor_override_stats(
            supervisor_id=supervisor_id,
            start_date=start_date,
            end_date=end_date,
        )
    except ServiceError as exc:
        raise _map_service_error(exc) from exc

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\permissions.py ---
from __future__ import annotations

from fastapi import APIRouter, Depends, HTTPException, Path, status

from app.api.deps import get_uow
from app.core.exceptions import (
    ServiceError,
    NotFoundError,
    ValidationError,
    ConflictError,
)
from app.schemas.admin.admin_permissions import (
    PermissionMatrix,
    RolePermissions,
    PermissionCheck,
)
from app.services.common.unit_of_work import UnitOfWork
from app.services.admin import PermissionMatrixService

router = APIRouter(prefix="/permissions")


def _map_service_error(exc: ServiceError) -> HTTPException:
    if isinstance(exc, NotFoundError):
        return HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=str(exc))
    if isinstance(exc, ValidationError):
        return HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(exc))
    if isinstance(exc, ConflictError):
        return HTTPException(status_code=status.HTTP_409_CONFLICT, detail=str(exc))
    return HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc))


@router.get(
    "/matrix",
    response_model=PermissionMatrix,
    summary="Get global role→permissions matrix",
)
async def get_permission_matrix(
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionMatrix:
    """
    Fetch the current role→permissions matrix.

    Backed by PermissionMatrixService.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.get_matrix()
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.put(
    "/matrix",
    response_model=PermissionMatrix,
    summary="Update global role→permissions matrix",
)
async def update_permission_matrix(
    payload: PermissionMatrix,
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionMatrix:
    """
    Replace the stored permission matrix.

    Should typically be restricted to super admins.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.update_matrix(matrix=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.get(
    "/roles/{role_name}",
    response_model=RolePermissions,
    summary="Get permissions for a specific role",
)
async def get_role_permissions(
    role_name: str = Path(..., description="Role name (e.g. HOSTEL_ADMIN)"),
    uow: UnitOfWork = Depends(get_uow),
) -> RolePermissions:
    """
    Fetch the permissions assigned to a specific role.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.get_role_permissions(role_name=role_name)
    except ServiceError as exc:
        raise _map_service_error(exc)


@router.post(
    "/check",
    response_model=PermissionCheck,
    summary="Check if a principal has a permission in a hostel",
)
async def check_permission(
    payload: PermissionCheck,
    uow: UnitOfWork = Depends(get_uow),
) -> PermissionCheck:
    """
    Check a single permission for a principal in the context of a hostel.

    Uses PermissionMatrixService.check_permission which bridges into RBACService.
    """
    service = PermissionMatrixService(uow)
    try:
        return service.check_permission(check=payload)
    except ServiceError as exc:
        raise _map_service_error(exc)

# --- File: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\__init__.py ---
"""
Admin API module for hostel management platform.

Provides comprehensive administrative functionality including:
- Dashboard and analytics
- Hostel management
- Admin-hostel assignments
- Permission matrix management
- Administrative overrides
- Multi-hostel dashboard views

All endpoints are designed for administrative users and include
proper authorization checks, audit logging, and error handling.
"""
from __future__ import annotations

from fastapi import APIRouter

from . import (
    dashboard,
    hostels,
    assignments,
    permissions,
    overrides,
    multi_hostel,
)

# Create main admin router
router = APIRouter(prefix="/admin", tags=["Admin"])

# Include sub-routers with clear organization
router.include_router(dashboard.router)
router.include_router(hostels.router)
router.include_router(assignments.router)
router.include_router(permissions.router)
router.include_router(overrides.router)
router.include_router(multi_hostel.router)

__all__ = [
    "router",
    "dashboard",
    "hostels",
    "assignments",
    "permissions",
    "overrides",
    "multi_hostel",
]


# ===== Folder: D:\Last Github Push\Last\HOStel-back\app\api\v1\admin\__pycache__ =====
