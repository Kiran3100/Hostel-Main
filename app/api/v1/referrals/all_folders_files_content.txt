### Combined Content from Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals ###



# ===== Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals =====

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals\codes.py ---
# app/api/v1/referrals/codes.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.referral import ReferralService
from app.schemas.referral.referral_code import (
    ReferralCodeGenerate,
    ReferralCodeResponse,
    CodeValidationRequest,
    CodeValidationResponse,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Referrals - Codes"])


def _get_service(session: Session) -> ReferralService:
    uow = UnitOfWork(session)
    return ReferralService(uow)


@router.post("/generate", response_model=ReferralCodeResponse)
def generate_referral_code(
    payload: ReferralCodeGenerate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> ReferralCodeResponse:
    """
    Generate a referral code for the authenticated user.

    (Typically 1 code per active program/user combination, but up to service logic.)
    """
    service = _get_service(session)
    # Expected: generate_code(referrer_id: UUID, data: ReferralCodeGenerate) -> ReferralCodeResponse
    return service.generate_code(
        referrer_id=current_user.id,
        data=payload,
    )


@router.post("/validate", response_model=CodeValidationResponse)
def validate_referral_code(
    payload: CodeValidationRequest,
    session: Session = Depends(get_session),
) -> CodeValidationResponse:
    """
    Validate a referral code (public endpoint).

    Returns validity, associated program/benefits, and potential referrer info.
    """
    service = _get_service(session)
    # Expected: validate_code(request: CodeValidationRequest) -> CodeValidationResponse
    return service.validate_code(request=payload)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals\programs.py ---
from datetime import date
from typing import List, Union
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.referral import ReferralProgramService
from app.schemas.referral.referral_program_base import ProgramCreate, ProgramUpdate
from app.schemas.referral.referral_program_response import ProgramResponse
from . import CurrentUser, get_current_user, get_current_admin

router = APIRouter(tags=["Referrals - Programs"])


def _get_service(session: Session) -> ReferralProgramService:
    uow = UnitOfWork(session)
    return ReferralProgramService(uow)


@router.get("/", response_model=List[ProgramResponse])
def list_programs(
    active_only: bool = Query(
        False,
        description="If true, return only active programs.",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[ProgramResponse]:
    """
    List referral programs (optionally active_only).

    Expected service method:
        list_programs(active_only: bool) -> list[ProgramResponse]
    """
    service = _get_service(session)
    return service.list_programs(active_only=active_only)


@router.get("/active", response_model=List[ProgramResponse])
def list_active_programs(
    as_of: Union[date, None] = Query(
        None,
        description="Filter programs active on this date (defaults to today).",
    ),
    session: Session = Depends(get_session),
) -> List[ProgramResponse]:
    """
    Public endpoint: list active referral programs (by validity window).
    """
    service = _get_service(session)
    # Expected service method:
    #   list_active_programs(as_of: Union[date, None]) -> list[ProgramResponse]
    return service.list_active_programs(as_of=as_of)


@router.get("/{program_id}", response_model=ProgramResponse)
def get_program(
    program_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> ProgramResponse:
    """
    Get a single referral program by ID.
    """
    service = _get_service(session)
    # Expected: get_program(program_id: UUID) -> ProgramResponse
    return service.get_program(program_id=program_id)


@router.post(
    "/",
    response_model=ProgramResponse,
    status_code=status.HTTP_201_CREATED,
)
def create_program(
    payload: ProgramCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> ProgramResponse:
    """
    Create a new referral program (admin-only).
    """
    service = _get_service(session)
    # Expected: create_program(data: ProgramCreate) -> ProgramResponse
    return service.create_program(data=payload)


@router.patch("/{program_id}", response_model=ProgramResponse)
def update_program(
    program_id: UUID,
    payload: ProgramUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> ProgramResponse:
    """
    Update an existing referral program (admin-only).
    """
    service = _get_service(session)
    # Expected: update_program(program_id: UUID, data: ProgramUpdate) -> ProgramResponse
    return service.update_program(
        program_id=program_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals\referrals.py ---
# app/api/v1/referrals/referrals.py
from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.referral import ReferralService
from app.schemas.referral.referral_base import ReferralCreate
from app.schemas.referral.referral_response import ReferralResponse, ReferralStats
from . import CurrentUser, get_current_user, get_current_admin

router = APIRouter(tags=["Referrals - Referrals"])


def _get_service(session: Session) -> ReferralService:
    uow = UnitOfWork(session)
    return ReferralService(uow)


@router.post("/", response_model=ReferralResponse)
def create_referral(
    payload: ReferralCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> ReferralResponse:
    """
    Create a referral record for the current user as referrer.
    """
    service = _get_service(session)
    # Expected: create_referral(referrer_id: UUID, data: ReferralCreate) -> ReferralResponse
    return service.create_referral(
        referrer_id=current_user.id,
        data=payload,
    )


@router.get("/me", response_model=ReferralStats)
def get_my_referral_stats(
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> ReferralStats:
    """
    Get aggregated referral statistics for the authenticated user.
    """
    service = _get_service(session)
    # Expected: get_stats_for_referrer(referrer_id: UUID) -> ReferralStats
    return service.get_stats_for_referrer(referrer_id=current_user.id)


@router.get("/me/list", response_model=List[ReferralResponse])
def list_my_referrals(
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[ReferralResponse]:
    """
    List all referrals created by the authenticated user.
    """
    service = _get_service(session)
    # Expected: list_referrals_for_referrer(referrer_id: UUID) -> list[ReferralResponse]
    return service.list_referrals_for_referrer(referrer_id=current_user.id)


@router.get("/{referral_id}", response_model=ReferralResponse)
def get_referral(
    referral_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> ReferralResponse:
    """
    Get a single referral record by ID.

    (Visible to admin or the referrer themselves.)
    """
    service = _get_service(session)
    # Expected: get_referral(referral_id: UUID, requester_id: UUID, requester_role: UserRole) -> ReferralResponse
    return service.get_referral(
        referral_id=referral_id,
        requester_id=current_user.id,
        requester_role=current_user.role,
    )


@router.get("/programs/{program_id}", response_model=List[ReferralResponse])
def list_referrals_for_program(
    program_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> List[ReferralResponse]:
    """
    Admin endpoint: list referrals under a given program.
    """
    service = _get_service(session)
    # Expected: list_referrals_for_program(program_id: UUID) -> list[ReferralResponse]
    return service.list_referrals_for_program(program_id=program_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals\rewards.py ---
# app/api/v1/referrals/rewards.py
from datetime import date as Date
from typing import Optional, List, Union
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.referral import ReferralRewardService
from app.schemas.referral.referral_rewards import (
    RewardConfig,
    RewardTracking,
    PayoutRequest,
    PayoutRequestResponse,
)
from . import CurrentUser, get_current_user, get_current_admin

router = APIRouter(tags=["Referrals - Rewards"])


def _get_service(session: Session) -> ReferralRewardService:
    uow = UnitOfWork(session)
    return ReferralRewardService(uow)


@router.get("/config", response_model=RewardConfig)
def get_reward_config(
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> RewardConfig:
    """
    Get global referral reward configuration (admin-only).
    """
    service = _get_service(session)
    # Expected: get_config() -> RewardConfig
    return service.get_config()


@router.put("/config", response_model=RewardConfig)
def update_reward_config(
    payload: RewardConfig,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> RewardConfig:
    """
    Update global referral reward configuration (admin-only).
    """
    service = _get_service(session)
    # Expected: update_config(data: RewardConfig) -> RewardConfig
    return service.update_config(data=payload)


@router.get("/me/tracking", response_model=RewardTracking)
def get_my_reward_tracking(
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RewardTracking:
    """
    Get referral rewards tracking for the authenticated user (earned/paid/pending).
    """
    service = _get_service(session)
    # Expected: get_tracking_for_user(user_id: UUID) -> RewardTracking
    return service.get_tracking_for_user(user_id=current_user.id)


@router.post("/payouts", response_model=PayoutRequestResponse, status_code=status.HTTP_201_CREATED)
def request_payout(
    payload: PayoutRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> PayoutRequestResponse:
    """
    Create a payout request for the authenticated user.

    Enforces minimum payout amounts via RewardConfig.
    """
    service = _get_service(session)
    # Expected: create_payout_request(user_id: UUID, data: PayoutRequest) -> PayoutRequestResponse
    return service.create_payout_request(
        user_id=current_user.id,
        data=payload,
    )


@router.get("/payouts", response_model=List[PayoutRequestResponse])
def list_payout_requests(
    status_filter: Union[str, None] = Query(
        None,
        description="Optional filter by payout status (e.g., pending, approved, paid).",
    ),
    start_date: Union[Date, None] = Query(
        None,
        description="Optional start Date for payout requests (inclusive).",
    ),
    end_date: Union[Date, None] = Query(
        None,
        description="Optional end Date for payout requests (inclusive).",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_admin),
) -> List[PayoutRequestResponse]:
    """
    Admin endpoint: list payout requests with optional filters.
    """
    service = _get_service(session)
    # Expected:
    #   list_payout_requests(
    #       status: Optional[str],
    #       start_date: Optional[Date],
    #       end_date: Optional[Date],
    #   ) -> list[PayoutRequestResponse]
    return service.list_payout_requests(
        status=status_filter,
        start_date=start_date,
        end_date=end_date,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\referrals\__init__.py ---
from dataclasses import dataclass
from typing import Any
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer

from app.core.security import decode_token, TokenDecodeError
from app.schemas.common.enums import UserRole

router = APIRouter()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login")


@dataclass
class CurrentUser:
    """Minimal representation of the authenticated user for referral APIs."""
    id: UUID
    role: UserRole


def get_current_user(token: str = Depends(oauth2_scheme)) -> CurrentUser:
    """
    Decode JWT and return minimal CurrentUser.

    Expects payload to contain either:
      - sub (user id as string) and role
      - or user_id and user_role
    """
    try:
        payload: dict[str, Any] = decode_token(token)
    except TokenDecodeError as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate credentials",
        ) from exc

    user_id_raw = payload.get("sub") or payload.get("user_id")
    role_raw = payload.get("role") or payload.get("user_role")

    if not user_id_raw or not role_raw:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        )

    try:
        user_id = UUID(str(user_id_raw))
        role = UserRole(str(role_raw))
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        ) from exc

    return CurrentUser(id=user_id, role=role)


def get_current_admin(current_user: CurrentUser = Depends(get_current_user)) -> CurrentUser:
    """Ensure the authenticated user is an ADMIN for admin-only referral endpoints."""
    if current_user.role is not UserRole.ADMIN:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Only admins can access this endpoint",
        )
    return current_user


# Import sub-routers and mount them under /referrals in the main API router.
from . import programs, referrals, codes, rewards  # noqa: E402

router.include_router(programs.router, prefix="/programs")
router.include_router(referrals.router, prefix="/referrals")
router.include_router(codes.router, prefix="/codes")
router.include_router(rewards.router, prefix="/rewards")

__all__ = [
    "router",
    "CurrentUser",
    "get_current_user",
    "get_current_admin",
]
