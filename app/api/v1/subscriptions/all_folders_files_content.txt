### Combined Content from Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions ###



# ===== Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions =====

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\billing.py ---
# app/api/v1/subscriptions/billing.py
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.subscription import SubscriptionBillingService
from app.schemas.subscription.subscription_billing import (
    BillingCycleInfo,
    GenerateInvoiceRequest,
    InvoiceInfo,
)
from app.schemas.subscription.subscription_response import BillingHistory
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Billing"])


def _get_service(session: Session) -> SubscriptionBillingService:
    uow = UnitOfWork(session)
    return SubscriptionBillingService(uow)


@router.get("/{subscription_id}/cycle", response_model=BillingCycleInfo)
def get_billing_cycle_info(
    subscription_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BillingCycleInfo:
    """
    Get billing cycle info for a subscription.

    Expected service method:
        get_billing_cycle_info(subscription_id: UUID) -> BillingCycleInfo
    """
    service = _get_service(session)
    return service.get_billing_cycle_info(subscription_id=subscription_id)


@router.post("/{subscription_id}/invoices", response_model=InvoiceInfo)
def generate_invoice(
    subscription_id: UUID,
    payload: GenerateInvoiceRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> InvoiceInfo:
    """
    Generate an invoice for a subscription.

    Expected service method:
        generate_invoice(subscription_id: UUID, data: GenerateInvoiceRequest) -> InvoiceInfo
    """
    service = _get_service(session)
    return service.generate_invoice(
        subscription_id=subscription_id,
        data=payload,
    )


@router.get("/{subscription_id}/history", response_model=BillingHistory)
def get_billing_history(
    subscription_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BillingHistory:
    """
    Get billing history for a subscription.

    Expected service method:
        get_billing_history(subscription_id: UUID) -> BillingHistory
    """
    service = _get_service(session)
    return service.get_billing_history(subscription_id=subscription_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\cancellation.py ---
# app/api/v1/subscriptions/cancellation.py
from __future__ import annotations

from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.subscription import SubscriptionService
from app.schemas.subscription.subscription_cancellation import (
    CancellationRequest,
    CancellationResponse,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Cancellation"])


def _get_service(session: Session) -> SubscriptionService:
    uow = UnitOfWork(session)
    return SubscriptionService(uow)


@router.post("/{subscription_id}", response_model=CancellationResponse)
def cancel_subscription(
    subscription_id: UUID,
    payload: CancellationRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> CancellationResponse:
    """
    Cancel a subscription and compute any applicable refunds / end dates.

    Expected service method:
        cancel_subscription(subscription_id: UUID, data: CancellationRequest) -> CancellationResponse
    """
    service = _get_service(session)
    return service.cancel_subscription(
        subscription_id=subscription_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\commission.py ---
# app/api/v1/subscriptions/commission.py
from __future__ import annotations

from datetime import date as Date 
from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.subscription import CommissionService
from app.schemas.subscription.commission import (
    CommissionConfig,
    BookingCommissionResponse,
    CommissionSummary,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Commission"])


def _get_service(session: Session) -> CommissionService:
    uow = UnitOfWork(session)
    return CommissionService(uow)


@router.get("/config", response_model=CommissionConfig)
def get_commission_config(
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> CommissionConfig:
    """
    Get current commission configuration.

    Expected service method:
        get_config() -> CommissionConfig
    """
    service = _get_service(session)
    return service.get_config()


@router.put("/config", response_model=CommissionConfig)
def update_commission_config(
    payload: CommissionConfig,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> CommissionConfig:
    """
    Update commission configuration.

    Expected service method:
        update_config(data: CommissionConfig) -> CommissionConfig
    """
    service = _get_service(session)
    return service.update_config(data=payload)


@router.get("/bookings/{booking_id}", response_model=BookingCommissionResponse)
def get_booking_commission(
    booking_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BookingCommissionResponse:
    """
    Get commission details for a specific booking.

    Expected service method:
        get_booking_commission(booking_id: UUID) -> BookingCommissionResponse
    """
    service = _get_service(session)
    return service.get_booking_commission(booking_id=booking_id)


@router.get("/summary", response_model=CommissionSummary)
def get_commission_summary(
    start_date: Date = Query(..., description="Start Date for the summary period"),
    end_date: Date = Query(..., description="End Date for the summary period"),
    plan_id: Optional[UUID] = Query(
        None,
        description="Optionally restrict summary to a specific subscription plan.",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> CommissionSummary:
    """
    Get commission summary for a period (optionally per plan).

    Expected service method:
        get_commission_summary(start_date: Date, end_date: Date, plan_id: Optional[UUID]) -> CommissionSummary
    """
    service = _get_service(session)
    return service.get_commission_summary(
        start_date=start_date,
        end_date=end_date,
        plan_id=plan_id,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\plans.py ---
# app/api/v1/subscriptions/plans.py
from __future__ import annotations

from typing import List, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.schemas.subscription.subscription_plan_base import PlanCreate, PlanUpdate
from app.schemas.subscription.subscription_plan_response import (
    PlanResponse,
    PlanComparison,
)
from app.services.subscription import SubscriptionPlanService
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Plans"])


def _get_service(session: Session) -> SubscriptionPlanService:
    uow = UnitOfWork(session)
    return SubscriptionPlanService(uow)


@router.get("/", response_model=List[PlanResponse])
def list_plans(
    public_only: bool = Query(
        True,
        description="If true, return only public plans; otherwise return all plans.",
    ),
    include_inactive: bool = Query(
        False,
        description="If true, include inactive plans (admin use).",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[PlanResponse]:
    """
    List subscription plans.

    Expected service method:
        list_plans(public_only: bool, include_inactive: bool) -> list[PlanResponse]
    """
    service = _get_service(session)
    return service.list_plans(
        public_only=public_only,
        include_inactive=include_inactive,
    )


@router.get("/public", response_model=List[PlanResponse])
def list_public_plans(
    session: Session = Depends(get_session),
) -> List[PlanResponse]:
    """
    Public endpoint: list only public & active plans (no auth required).

    Expected service method:
        list_public_plans() -> list[PlanResponse]
    """
    service = _get_service(session)
    return service.list_public_plans()


@router.get("/comparison", response_model=PlanComparison)
def compare_plans(
    plan_ids: Optional[List[UUID]] = Query(
        None,
        description="Optional list of plan IDs to compare; if omitted, compare all public plans.",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> PlanComparison:
    """
    Compare plans via feature matrix.

    Expected service method:
        get_plan_comparison(plan_ids: Optional[list[UUID]]) -> PlanComparison
    """
    service = _get_service(session)
    return service.get_plan_comparison(plan_ids=plan_ids)


@router.get("/{plan_id}", response_model=PlanResponse)
def get_plan(
    plan_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> PlanResponse:
    """
    Get a single subscription plan by ID.

    Expected service method:
        get_plan(plan_id: UUID) -> PlanResponse
    """
    service = _get_service(session)
    return service.get_plan(plan_id=plan_id)


@router.post(
    "/",
    response_model=PlanResponse,
    status_code=status.HTTP_201_CREATED,
)
def create_plan(
    payload: PlanCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> PlanResponse:
    """
    Create a new subscription plan.

    Expected service method:
        create_plan(data: PlanCreate) -> PlanResponse
    """
    service = _get_service(session)
    return service.create_plan(data=payload)


@router.patch("/{plan_id}", response_model=PlanResponse)
def update_plan(
    plan_id: UUID,
    payload: PlanUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> PlanResponse:
    """
    Update an existing subscription plan.

    Expected service method:
        update_plan(plan_id: UUID, data: PlanUpdate) -> PlanResponse
    """
    service = _get_service(session)
    return service.update_plan(
        plan_id=plan_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\subscriptions.py ---
# app/api/v1/subscriptions/subscriptions.py
from __future__ import annotations

from typing import List, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.subscription import SubscriptionService
from app.schemas.subscription.subscription_base import (
    SubscriptionCreate,
    SubscriptionUpdate,
)
from app.schemas.subscription.subscription_response import (
    SubscriptionResponse,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Subscriptions"])


def _get_service(session: Session) -> SubscriptionService:
    uow = UnitOfWork(session)
    return SubscriptionService(uow)


@router.get("/", response_model=List[SubscriptionResponse])
def list_subscriptions(
    hostel_id: Optional[UUID] = Query(
        None,
        description="Optionally filter subscriptions by hostel ID.",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[SubscriptionResponse]:
    """
    List subscriptions, optionally filtered by hostel.

    Expected service method:
        list_subscriptions(hostel_id: Optional[UUID]) -> list[SubscriptionResponse]
    """
    service = _get_service(session)
    return service.list_subscriptions(hostel_id=hostel_id)


@router.get("/{subscription_id}", response_model=SubscriptionResponse)
def get_subscription(
    subscription_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> SubscriptionResponse:
    """
    Get details of a single subscription.

    Expected service method:
        get_subscription(subscription_id: UUID) -> SubscriptionResponse
    """
    service = _get_service(session)
    return service.get_subscription(subscription_id=subscription_id)


@router.post(
    "/",
    response_model=SubscriptionResponse,
    status_code=status.HTTP_201_CREATED,
)
def create_subscription(
    payload: SubscriptionCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> SubscriptionResponse:
    """
    Create a new hostel subscription.

    Expected service method:
        create_subscription(data: SubscriptionCreate) -> SubscriptionResponse
    """
    service = _get_service(session)
    return service.create_subscription(data=payload)


@router.patch("/{subscription_id}", response_model=SubscriptionResponse)
def update_subscription(
    subscription_id: UUID,
    payload: SubscriptionUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> SubscriptionResponse:
    """
    Update an existing subscription.

    Expected service method:
        update_subscription(subscription_id: UUID, data: SubscriptionUpdate) -> SubscriptionResponse
    """
    service = _get_service(session)
    return service.update_subscription(
        subscription_id=subscription_id,
        data=payload,
    )


@router.get("/hostels/{hostel_id}/active", response_model=Optional[SubscriptionResponse])
def get_active_subscription_for_hostel(
    hostel_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> Optional[SubscriptionResponse]:
    """
    Get the active subscription for a hostel (if any).

    Expected service method:
        get_active_subscription_for_hostel(hostel_id: UUID) -> Optional[SubscriptionResponse]
    """
    service = _get_service(session)
    return service.get_active_subscription_for_hostel(hostel_id=hostel_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\upgrade.py ---
# app/api/v1/subscriptions/upgrade.py
from __future__ import annotations

from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.subscription import SubscriptionUpgradeService
from app.schemas.subscription.subscription_upgrade import (
    UpgradeRequest,
    UpgradePreview,
    DowngradeRequest,
)
from app.schemas.subscription.subscription_response import SubscriptionResponse
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Subscription - Upgrade"])


def _get_service(session: Session) -> SubscriptionUpgradeService:
    uow = UnitOfWork(session)
    return SubscriptionUpgradeService(uow)


@router.post("/{subscription_id}/preview", response_model=UpgradePreview)
def preview_upgrade(
    subscription_id: UUID,
    payload: UpgradeRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> UpgradePreview:
    """
    Preview financial impact of upgrading a subscription (proration, etc.).

    Expected service method:
        preview_upgrade(subscription_id: UUID, data: UpgradeRequest) -> UpgradePreview
    """
    service = _get_service(session)
    return service.preview_upgrade(
        subscription_id=subscription_id,
        data=payload,
    )


@router.post("/{subscription_id}/apply", response_model=SubscriptionResponse)
def apply_upgrade(
    subscription_id: UUID,
    payload: UpgradeRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> SubscriptionResponse:
    """
    Apply an upgrade to a subscription.

    Expected service method:
        apply_upgrade(subscription_id: UUID, data: UpgradeRequest) -> SubscriptionResponse
    """
    service = _get_service(session)
    return service.apply_upgrade(
        subscription_id=subscription_id,
        data=payload,
    )


@router.post("/{subscription_id}/downgrade", response_model=SubscriptionResponse)
def apply_downgrade(
    subscription_id: UUID,
    payload: DowngradeRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> SubscriptionResponse:
    """
    Apply a downgrade to a subscription.

    Expected service method:
        apply_downgrade(subscription_id: UUID, data: DowngradeRequest) -> SubscriptionResponse
    """
    service = _get_service(session)
    return service.apply_downgrade(
        subscription_id=subscription_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\subscriptions\__init__.py ---
# app/api/v1/subscriptions/__init__.py
from __future__ import annotations

from dataclasses import dataclass
from typing import Any
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer

from app.core.security import decode_token, TokenDecodeError
from app.schemas.common.enums import UserRole

router = APIRouter()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login")


@dataclass
class CurrentUser:
    """Minimal representation of the authenticated user for subscription APIs."""
    id: UUID
    role: UserRole


def get_current_user(token: str = Depends(oauth2_scheme)) -> CurrentUser:
    """
    Decode JWT and return minimal CurrentUser.

    Expects payload to contain either:
      - sub (user id as string) and role
      - or user_id and user_role

    Adjust this if your TokenPayload uses different claim names.
    """
    try:
        payload: dict[str, Any] = decode_token(token)
    except TokenDecodeError as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate credentials",
        ) from exc

    user_id_raw = payload.get("sub") or payload.get("user_id")
    role_raw = payload.get("role") or payload.get("user_role")

    if not user_id_raw or not role_raw:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        )

    try:
        user_id = UUID(str(user_id_raw))
        role = UserRole(str(role_raw))
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        ) from exc

    return CurrentUser(id=user_id, role=role)


# Import sub-routers and mount them.
from . import plans, subscriptions, upgrade, billing, cancellation, commission  # noqa: E402

router.include_router(plans.router, prefix="/plans")
router.include_router(subscriptions.router, prefix="/subscriptions")
router.include_router(upgrade.router, prefix="/upgrade")
router.include_router(billing.router, prefix="/billing")
router.include_router(cancellation.router, prefix="/cancellation")
router.include_router(commission.router, prefix="/commission")

__all__ = [
    "router",
    "CurrentUser",
    "get_current_user",
]
