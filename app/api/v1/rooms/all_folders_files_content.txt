### Combined Content from Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms ###



# ===== Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms =====

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms\assignment.py ---
# app/api/v1/rooms/assignment.py
from __future__ import annotations

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.room import BedAssignmentService
from app.schemas.room.bed_base import (
    BedAssignmentRequest,
    BedReleaseRequest,
)
from app.schemas.room.bed_response import (
    BedAssignment,
    BedAssignmentHistory,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Rooms - Bed Assignment"])


def _get_service(session: Session) -> BedAssignmentService:
    uow = UnitOfWork(session)
    return BedAssignmentService(uow)


@router.post("/", response_model=BedAssignment)
def assign_bed(
    payload: BedAssignmentRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedAssignment:
    """
    Assign a bed to a student.

    Expected service method:
        assign_bed(data: BedAssignmentRequest) -> BedAssignment
    """
    service = _get_service(session)
    return service.assign_bed(data=payload)


@router.post("/release", response_model=BedAssignment)
def release_bed(
    payload: BedReleaseRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedAssignment:
    """
    Release a bed from its current student.

    Expected service method:
        release_bed(data: BedReleaseRequest) -> BedAssignment
    """
    service = _get_service(session)
    return service.release_bed(data=payload)


@router.get("/history/{bed_id}", response_model=BedAssignmentHistory)
def get_bed_assignment_history(
    bed_id: str,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedAssignmentHistory:
    """
    Get assignment history for a bed (wrapper around StudentRoomAssignment history).

    Expected service method:
        get_bed_assignment_history(bed_id: UUID | str) -> BedAssignmentHistory
    """
    service = _get_service(session)
    return service.get_bed_assignment_history(bed_id=bed_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms\availability.py ---
# app/api/v1/rooms/availability.py
from __future__ import annotations

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.room import RoomAvailabilityService
from app.schemas.room.room_availability import (
    RoomAvailabilityRequest,
    AvailabilityResponse,
)

router = APIRouter(tags=["Rooms - Availability"])


def _get_service(session: Session) -> RoomAvailabilityService:
    uow = UnitOfWork(session)
    return RoomAvailabilityService(uow)


@router.post("/", response_model=AvailabilityResponse)
def get_room_availability(
    payload: RoomAvailabilityRequest,
    session: Session = Depends(get_session),
) -> AvailabilityResponse:
    """
    Compute room availability for a hostel/Date/room_type combination.

    Expected service method:
        get_availability(request: RoomAvailabilityRequest) -> AvailabilityResponse
    """
    service = _get_service(session)
    return service.get_availability(request=payload)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms\beds.py ---
# app/api/v1/rooms/beds.py
from __future__ import annotations

from typing import List
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.room import BedService
from app.schemas.room.bed_base import (
    BedCreate,
    BedUpdate,
    BulkBedCreate,
)
from app.schemas.room.bed_response import (
    BedResponse,
    BedAvailability,
    BedHistory,
)
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Rooms - Beds"])


def _get_service(session: Session) -> BedService:
    uow = UnitOfWork(session)
    return BedService(uow)


@router.get("/{bed_id}", response_model=BedResponse)
def get_bed(
    bed_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedResponse:
    """
    Get a single bed by ID.

    Expected service method:
        get_bed(bed_id: UUID) -> BedResponse
    """
    service = _get_service(session)
    return service.get_bed(bed_id=bed_id)


@router.get("/by-room/{room_id}", response_model=List[BedResponse])
def list_beds_for_room(
    room_id: UUID,
    only_available: bool = Query(
        False,
        description="If true, return only beds that are currently available",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[BedResponse]:
    """
    List beds for a specific room.

    Expected service method:
        list_beds_for_room(room_id: UUID, only_available: bool) -> list[BedResponse]
    """
    service = _get_service(session)
    return service.list_beds_for_room(
        room_id=room_id,
        only_available=only_available,
    )


@router.get("/{bed_id}/availability", response_model=BedAvailability)
def get_bed_availability(
    bed_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedAvailability:
    """
    Get simple availability info for a bed.

    Expected service method:
        get_bed_availability(bed_id: UUID) -> BedAvailability
    """
    service = _get_service(session)
    return service.get_bed_availability(bed_id=bed_id)


@router.get("/{bed_id}/history", response_model=BedHistory)
def get_bed_history(
    bed_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedHistory:
    """
    Get assignment history for a bed.

    Expected service method:
        get_bed_history(bed_id: UUID) -> BedHistory
    """
    service = _get_service(session)
    return service.get_bed_history(bed_id=bed_id)


@router.post(
    "/",
    response_model=BedResponse,
    status_code=status.HTTP_201_CREATED,
)
def create_bed(
    payload: BedCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedResponse:
    """
    Create a single bed.

    Expected service method:
        create_bed(data: BedCreate) -> BedResponse
    """
    service = _get_service(session)
    return service.create_bed(data=payload)


@router.post(
    "/bulk",
    response_model=List[BedResponse],
    status_code=status.HTTP_201_CREATED,
)
def bulk_create_beds(
    payload: BulkBedCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[BedResponse]:
    """
    Bulk-create beds for a room.

    Expected service method:
        bulk_create_beds(data: BulkBedCreate) -> list[BedResponse]
    """
    service = _get_service(session)
    return service.bulk_create_beds(data=payload)


@router.patch("/{bed_id}", response_model=BedResponse)
def update_bed(
    bed_id: UUID,
    payload: BedUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> BedResponse:
    """
    Update bed metadata or status.

    Expected service method:
        update_bed(bed_id: UUID, data: BedUpdate) -> BedResponse
    """
    service = _get_service(session)
    return service.update_bed(
        bed_id=bed_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms\rooms.py ---
# app/api/v1/rooms/rooms.py
from __future__ import annotations

from typing import List, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.schemas.common.enums import RoomType
from app.schemas.room.room_base import (
    RoomCreate,
    RoomUpdate,
    BulkRoomCreate,
    RoomPricingUpdate,
    RoomStatusUpdate,
)
from app.schemas.room.room_response import (
    RoomListItem,
    RoomDetail,
    RoomWithBeds,
    RoomOccupancyStats,
)
from app.services import UnitOfWork
from app.services.room import RoomService
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Rooms"])


def _get_service(session: Session) -> RoomService:
    uow = UnitOfWork(session)
    return RoomService(uow)


@router.get("/", response_model=List[RoomListItem])
def list_rooms(
    hostel_id: UUID = Query(..., description="Hostel ID to list rooms for"),
    only_available: bool = Query(
        False,
        description="If true, return only rooms available for booking",
    ),
    room_type: Optional[RoomType] = Query(
        None,
        description="Optional filter by room type",
    ),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[RoomListItem]:
    """
    List rooms for a hostel with optional filters.

    Expected service method:
        list_rooms(hostel_id: UUID, only_available: bool, room_type: Optional[RoomType])
            -> list[RoomListItem]
    """
    service = _get_service(session)
    return service.list_rooms(
        hostel_id=hostel_id,
        only_available=only_available,
        room_type=room_type,
    )


@router.get("/{room_id}", response_model=RoomDetail)
def get_room(
    room_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomDetail:
    """
    Get detailed information for a single room.

    Expected service method:
        get_room_detail(room_id: UUID) -> RoomDetail
    """
    service = _get_service(session)
    return service.get_room_detail(room_id=room_id)


@router.get("/{room_id}/with-beds", response_model=RoomWithBeds)
def get_room_with_beds(
    room_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomWithBeds:
    """
    Get room details including bed information.

    Expected service method:
        get_room_with_beds(room_id: UUID) -> RoomWithBeds
    """
    service = _get_service(session)
    return service.get_room_with_beds(room_id=room_id)


@router.get("/{room_id}/occupancy", response_model=RoomOccupancyStats)
def get_room_occupancy_stats(
    room_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomOccupancyStats:
    """
    Get occupancy and revenue projection stats for a room.

    Expected service method:
        get_room_occupancy_stats(room_id: UUID) -> RoomOccupancyStats
    """
    service = _get_service(session)
    return service.get_room_occupancy_stats(room_id=room_id)


@router.post(
    "/",
    response_model=RoomDetail,
    status_code=status.HTTP_201_CREATED,
)
def create_room(
    payload: RoomCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomDetail:
    """
    Create a single room.

    Expected service method:
        create_room(data: RoomCreate) -> RoomDetail
    """
    service = _get_service(session)
    return service.create_room(data=payload)


@router.post(
    "/bulk",
    response_model=List[RoomDetail],
    status_code=status.HTTP_201_CREATED,
)
def bulk_create_rooms(
    payload: BulkRoomCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[RoomDetail]:
    """
    Bulk-create rooms for a hostel.

    Expected service method:
        bulk_create_rooms(data: BulkRoomCreate) -> list[RoomDetail]
    """
    service = _get_service(session)
    return service.bulk_create_rooms(data=payload)


@router.patch("/{room_id}", response_model=RoomDetail)
def update_room(
    room_id: UUID,
    payload: RoomUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomDetail:
    """
    Update room metadata and configuration.

    Expected service method:
        update_room(room_id: UUID, data: RoomUpdate) -> RoomDetail
    """
    service = _get_service(session)
    return service.update_room(
        room_id=room_id,
        data=payload,
    )


@router.patch("/{room_id}/pricing", response_model=RoomDetail)
def update_room_pricing(
    room_id: UUID,
    payload: RoomPricingUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomDetail:
    """
    Update pricing for a room.

    Expected service method:
        update_room_pricing(room_id: UUID, data: RoomPricingUpdate) -> RoomDetail
    """
    service = _get_service(session)
    return service.update_room_pricing(
        room_id=room_id,
        data=payload,
    )


@router.patch("/{room_id}/status", response_model=RoomDetail)
def update_room_status(
    room_id: UUID,
    payload: RoomStatusUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomDetail:
    """
    Update availability/status flags for a room.

    Expected service method:
        update_room_status(room_id: UUID, data: RoomStatusUpdate) -> RoomDetail
    """
    service = _get_service(session)
    return service.update_room_status(
        room_id=room_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\rooms\__init__.py ---
# app/api/v1/rooms/__init__.py
from __future__ import annotations

from dataclasses import dataclass
from typing import Any
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer

from app.core.security import decode_token, TokenDecodeError
from app.schemas.common.enums import UserRole

router = APIRouter()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login")


@dataclass
class CurrentUser:
    """Minimal representation of the authenticated user for room APIs."""
    id: UUID
    role: UserRole


def get_current_user(token: str = Depends(oauth2_scheme)) -> CurrentUser:
    """
    Decode JWT and return minimal CurrentUser.

    Expects payload to contain either:
      - sub (user id as string) and role
      - or user_id and user_role
    """
    try:
        payload: dict[str, Any] = decode_token(token)
    except TokenDecodeError as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate credentials",
        ) from exc

    user_id_raw = payload.get("sub") or payload.get("user_id")
    role_raw = payload.get("role") or payload.get("user_role")

    if not user_id_raw or not role_raw:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        )

    try:
        user_id = UUID(str(user_id_raw))
        role = UserRole(str(role_raw))
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        ) from exc

    return CurrentUser(id=user_id, role=role)


# Import sub-routers and mount them under /rooms in the main API router.
from . import rooms, availability, beds, assignment  # noqa: E402

router.include_router(rooms.router)
router.include_router(availability.router, prefix="/availability")
router.include_router(beds.router, prefix="/beds")
router.include_router(assignment.router, prefix="/assignment")

__all__ = [
    "router",
    "CurrentUser",
    "get_current_user",
]
