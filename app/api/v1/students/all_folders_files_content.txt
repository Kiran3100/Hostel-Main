### Combined Content from Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students ###



# ===== Folder: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students =====

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\dashboard.py ---
# app/api/v1/students/dashboard.py
from __future__ import annotations

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentDashboardService
from app.schemas.student.student_dashboard import StudentDashboard
from . import CurrentUser, get_current_student

router = APIRouter(tags=["Students - Dashboard"])


def _get_service(session: Session) -> StudentDashboardService:
    uow = UnitOfWork(session)
    return StudentDashboardService(uow)


@router.get("/", response_model=StudentDashboard)
def get_my_dashboard(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentDashboard:
    """
    Return the dashboard for the authenticated student.

    Expected service method:
        get_dashboard_for_user(user_id: UUID) -> StudentDashboard
    """
    service = _get_service(session)
    return service.get_dashboard_for_user(user_id=current_user.id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\finance.py ---
# app/api/v1/students/finance.py
from __future__ import annotations

from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentFinanceService
from app.schemas.student.student_dashboard import StudentFinancialSummary
from app.schemas.student.student_response import StudentFinancialInfo
from . import CurrentUser, get_current_user, get_current_student

router = APIRouter(tags=["Students - Finance"])


def _get_service(session: Session) -> StudentFinanceService:
    uow = UnitOfWork(session)
    return StudentFinanceService(uow)


@router.get("/me/summary", response_model=StudentFinancialSummary)
def get_my_financial_summary(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentFinancialSummary:
    """
    Financial summary for the authenticated student (due/overdue/next due).

    Expected service method:
        get_summary_for_user(user_id: UUID) -> StudentFinancialSummary
    """
    service = _get_service(session)
    return service.get_summary_for_user(user_id=current_user.id)


@router.get("/{student_id}/summary", response_model=StudentFinancialSummary)
def get_financial_summary_for_student(
    student_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> StudentFinancialSummary:
    """
    Admin endpoint: financial summary for a specific student.

    Expected service method:
        get_summary_for_student(student_id: UUID) -> StudentFinancialSummary
    """
    service = _get_service(session)
    return service.get_summary_for_student(student_id=student_id)


@router.get("/{student_id}/detail", response_model=StudentFinancialInfo)
def get_financial_detail_for_student(
    student_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> StudentFinancialInfo:
    """
    Admin endpoint: detailed financial info for a specific student.

    Expected service method:
        get_financial_info(student_id: UUID) -> StudentFinancialInfo
    """
    service = _get_service(session)
    return service.get_financial_info(student_id=student_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\profile.py ---
# app/api/v1/students/profile.py
from __future__ import annotations

from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentProfileService
from app.schemas.student.student_profile import (
    StudentProfileUpdate,
    StudentDocuments,
    DocumentInfo,
    DocumentUploadRequest,
    DocumentVerificationRequest,
    StudentPreferences,
)
from app.schemas.student.student_response import StudentDetail
from . import CurrentUser, get_current_student

router = APIRouter(tags=["Students - Profile"])


def _get_service(session: Session) -> StudentProfileService:
    uow = UnitOfWork(session)
    return StudentProfileService(uow)


@router.get("/", response_model=StudentDetail)
def get_my_student_profile(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentDetail:
    """
    Get the student profile for the authenticated student user.

    Expected service method:
        get_profile_for_user(user_id: UUID) -> StudentDetail
    """
    service = _get_service(session)
    return service.get_profile_for_user(user_id=current_user.id)


@router.patch("", response_model=StudentDetail)
def update_my_student_profile(
    payload: StudentProfileUpdate,
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentDetail:
    """
    Update profile fields (guardian, institution, employment, preferences) for the current student.

    Expected service method:
        update_profile_for_user(user_id: UUID, data: StudentProfileUpdate) -> StudentDetail
    """
    service = _get_service(session)
    return service.update_profile_for_user(
        user_id=current_user.id,
        data=payload,
    )


@router.get("/preferences", response_model=StudentPreferences)
def get_my_preferences(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentPreferences:
    """
    Get preferences for the authenticated student.

    Expected service method:
        get_preferences_for_user(user_id: UUID) -> StudentPreferences
    """
    service = _get_service(session)
    return service.get_preferences_for_user(user_id=current_user.id)


@router.patch("/preferences", response_model=StudentPreferences)
def update_my_preferences(
    payload: StudentPreferences,
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentPreferences:
    """
    Update preferences for the authenticated student.

    Expected service method:
        update_preferences_for_user(user_id: UUID, data: StudentPreferences) -> StudentPreferences
    """
    service = _get_service(session)
    return service.update_preferences_for_user(
        user_id=current_user.id,
        data=payload,
    )


@router.get("/documents", response_model=StudentDocuments)
def list_my_documents(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> StudentDocuments:
    """
    List all documents for the authenticated student.

    Expected service method:
        list_documents_for_user(user_id: UUID) -> StudentDocuments
    """
    service = _get_service(session)
    return service.list_documents_for_user(user_id=current_user.id)


@router.post("/documents/upload", response_model=DocumentInfo)
def init_document_upload(
    payload: DocumentUploadRequest,
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> DocumentInfo:
    """
    Initialize a document upload for the student (returns metadata / upload target).

    Expected service method:
        init_document_upload(user_id: UUID, data: DocumentUploadRequest) -> DocumentInfo
    """
    service = _get_service(session)
    return service.init_document_upload(
        user_id=current_user.id,
        data=payload,
    )


@router.post("/documents/{document_id}/verify", response_model=DocumentInfo)
def verify_document(
    document_id: UUID,
    payload: DocumentVerificationRequest,
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> DocumentInfo:
    """
    Submit verification info for an uploaded document.

    Expected service method:
        verify_document(user_id: UUID, document_id: UUID, data: DocumentVerificationRequest) -> DocumentInfo
    """
    service = _get_service(session)
    return service.verify_document(
        user_id=current_user.id,
        document_id=document_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\room_history.py ---
# app/api/v1/students/room_history.py
from __future__ import annotations

from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentRoomHistoryService
from app.schemas.student.student_room_history import RoomHistoryResponse
from . import CurrentUser, get_current_user, get_current_student

router = APIRouter(tags=["Students - Room History"])


def _get_service(session: Session) -> StudentRoomHistoryService:
    uow = UnitOfWork(session)
    return StudentRoomHistoryService(uow)


@router.get("/", response_model=RoomHistoryResponse)
def get_my_room_history(
    current_user: CurrentUser = Depends(get_current_student),
    session: Session = Depends(get_session),
) -> RoomHistoryResponse:
    """
    Get room/bed history for the authenticated student.

    Expected service method:
        get_history_for_user(user_id: UUID) -> RoomHistoryResponse
    """
    service = _get_service(session)
    return service.get_history_for_user(user_id=current_user.id)


@router.get("/{student_id}", response_model=RoomHistoryResponse)
def get_room_history_for_student(
    student_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> RoomHistoryResponse:
    """
    Admin endpoint: get room/bed history for a specific student.

    Expected service method:
        get_history_for_student(student_id: UUID) -> RoomHistoryResponse
    """
    service = _get_service(session)
    return service.get_history_for_student(student_id=student_id)

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\search.py ---
# app/api/v1/students/search.py
from __future__ import annotations

from typing import List

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentSearchService
from app.schemas.student.student_filters import (
    StudentSearchRequest,
    StudentExportRequest,
)
from app.schemas.student.student_response import StudentListItem
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Students - Search"])


def _get_service(session: Session) -> StudentSearchService:
    uow = UnitOfWork(session)
    return StudentSearchService(uow)


@router.post("/", response_model=List[StudentListItem])
def search_students(
    payload: StudentSearchRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[StudentListItem]:
    """
    Advanced student search over name, email, phone, room, institution, etc.

    Expected service method:
        search(request: StudentSearchRequest) -> list[StudentListItem]
    """
    service = _get_service(session)
    return service.search(request=payload)


@router.post("/export")
def export_students(
    payload: StudentExportRequest,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> dict:
    """
    Export students matching given criteria.

    This returns a simple metadata dict; you can adapt it to stream files
    or integrate with your generic export service.

    Expected service method:
        export(request: StudentExportRequest) -> dict | ExportResult
    """
    service = _get_service(session)
    result = service.export(request=payload)
    # Assume result is already JSON-serializable (e.g., { "url": "...", "format": "csv" })
    return result

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\students.py ---
# app/api/v1/students/students.py
from __future__ import annotations

from typing import List, Optional
from uuid import UUID

from fastapi import APIRouter, Depends, Query, status
from sqlalchemy.orm import Session

from app.core import get_session
from app.services import UnitOfWork
from app.services.student import StudentService
from app.schemas.student.student_base import StudentCreate, StudentUpdate
from app.schemas.student.student_response import (
    StudentDetail,
    StudentListItem,
)
from app.schemas.student.student_filters import StudentFilterParams
from . import CurrentUser, get_current_user

router = APIRouter(tags=["Students"])


def _get_service(session: Session) -> StudentService:
    uow = UnitOfWork(session)
    return StudentService(uow)


@router.get("/", response_model=List[StudentListItem])
def list_students(
    filters: StudentFilterParams = Depends(),
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[StudentListItem]:
    """
    List students with advanced filters and sorting.

    Expected service method:
        list_students(filters: StudentFilterParams) -> list[StudentListItem]
    """
    service = _get_service(session)
    return service.list_students(filters=filters)


@router.get("/hostels/{hostel_id}", response_model=List[StudentListItem])
def list_students_for_hostel(
    hostel_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> List[StudentListItem]:
    """
    List students for a specific hostel.

    Expected service method:
        list_students_for_hostel(hostel_id: UUID) -> list[StudentListItem]
    """
    service = _get_service(session)
    return service.list_students_for_hostel(hostel_id=hostel_id)


@router.get("/{student_id}", response_model=StudentDetail)
def get_student(
    student_id: UUID,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> StudentDetail:
    """
    Get detailed information for a single student.

    Expected service method:
        get_student_detail(student_id: UUID) -> StudentDetail
    """
    service = _get_service(session)
    return service.get_student_detail(student_id=student_id)


@router.post(
    "/",
    response_model=StudentDetail,
    status_code=status.HTTP_201_CREATED,
)
def create_student(
    payload: StudentCreate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> StudentDetail:
    """
    Create a new student (admin-only operation).

    Expected service method:
        create_student(data: StudentCreate) -> StudentDetail
    """
    service = _get_service(session)
    return service.create_student(data=payload)


@router.patch("/{student_id}", response_model=StudentDetail)
def update_student(
    student_id: UUID,
    payload: StudentUpdate,
    session: Session = Depends(get_session),
    current_user: CurrentUser = Depends(get_current_user),
) -> StudentDetail:
    """
    Update an existing student.

    Expected service method:
        update_student(student_id: UUID, data: StudentUpdate) -> StudentDetail
    """
    service = _get_service(session)
    return service.update_student(
        student_id=student_id,
        data=payload,
    )

# --- File: D:\Last Github Push\Last\Hostel-Main\app\api\v1\students\__init__.py ---
# app/api/v1/students/__init__.py
from __future__ import annotations

from dataclasses import dataclass
from typing import Any
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer

from app.core.security import decode_token, TokenDecodeError
from app.schemas.common.enums import UserRole

router = APIRouter()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login")


@dataclass
class CurrentUser:
    """Minimal representation of the authenticated user."""
    id: UUID
    role: UserRole


def get_current_user(token: str = Depends(oauth2_scheme)) -> CurrentUser:
    """
    Decode JWT and return minimal CurrentUser.

    Expects payload to contain either:
      - sub (user id as string) and role
      - or user_id and user_role
    """
    try:
        payload: dict[str, Any] = decode_token(token)
    except TokenDecodeError as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate credentials",
        ) from exc

    user_id_raw = payload.get("sub") or payload.get("user_id")
    role_raw = payload.get("role") or payload.get("user_role")

    if not user_id_raw or not role_raw:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        )

    try:
        user_id = UUID(str(user_id_raw))
        role = UserRole(str(role_raw))
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token payload",
        ) from exc

    return CurrentUser(id=user_id, role=role)


def get_current_student(current_user: CurrentUser = Depends(get_current_user)) -> CurrentUser:
    """Ensure the authenticated user is a STUDENT."""
    if current_user.role is not UserRole.STUDENT:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Only students can access this endpoint",
        )
    return current_user


# Import sub-routers and mount them under /students in the main API router.
from . import students, profile, dashboard, room_history, finance, search  # noqa: E402

# Admin/student management endpoints
router.include_router(students.router)
# Self-profile for current student
router.include_router(profile.router, prefix="/profile")
# Self dashboard
router.include_router(dashboard.router, prefix="/dashboard")
# Room/bed history
router.include_router(room_history.router, prefix="/room-history")
# Finance
router.include_router(finance.router, prefix="/finance")
# Search
router.include_router(search.router, prefix="/search")

__all__ = [
    "router",
    "CurrentUser",
    "get_current_user",
    "get_current_student",
]
